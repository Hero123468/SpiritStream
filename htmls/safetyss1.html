<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bible Daily TTS (KJV Only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f7;
      color: #222;
    }
    h1 { font-size: 1.6rem; margin-bottom: 0.25rem; }
    h2 { font-size: 1.2rem; margin-top: 1.5rem; }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }
    label { font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 0.25rem; }
    input {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    button {
      padding: 0.5rem 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }
    button.primary { background: #2563eb; color: white; }
    button.secondary { background: #e5e7eb; color: #111827; }
    .small { font-size: 0.8rem; color: #555; }
    .status { font-size: 0.85rem; margin-top: 0.5rem; color: #374151; }
    .error { color: #b91c1c; }
    .success { color: #166534; }
    #chapterText {
      max-height: 50vh;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 0.95rem;
    }
    body.dark {
  background: #1a1a1a;
  color: #e5e5e5;
}

#progressContainer {
  width: 100%;
  height: 6px;
  background: #ddd;
  border-radius: 3px;
  overflow: hidden;
  margin: 0.75rem 0;
}

#progressBar {
  width: 0%;
  height: 100%;
  background: #2563eb;
  transition: width 0.25s linear;
}

/* Dark mode support */
body.dark #progressContainer {
  background: #444;
}

body.dark #progressBar {
  background: #3b82f6;
}


body.dark .card {
  background: #2a2a2a;
  box-shadow: 0 2px 6px rgba(255,255,255,0.05);
}

body.dark input {
  background: #333;
  color: #eee;
  border: 1px solid #555;
}

body.dark button.secondary {
  background: #444;
  color: #eee;
}

body.dark button.primary {
  background: #3b82f6;
}

body.dark .status {
  color: #ccc;
}

body.dark .error {
  color: #f87171;
}

body.dark .success {
  color: #4ade80;
}

body.dark #chapterText {
  background: #222;
}


  </style>
</head>
<body>

  <head>
  <meta charset="UTF-8">
  <title>Spirit Stream</title>
  <link rel="stylesheet" href="styles.css">
</head> -->

<!--<body - ->

  <!-- Theme Toggle Button -->
  button id="toggleTheme" class="secondary" style="margin-bottom: 1rem;">
    Dark Mode
  <!--button -->

  <!-- Playlist-Level Progress Bar -->
  <!-- <div id="playlistProgressContainer">
    <div id="playlistProgressBar"></div>
  </div> -->

  <!-- Play Button with Circular Progress Ring -->
  <!--<div id="playWrapper">
    <svg id="playRing" width="80" height="80">
      <circle cx="40" cy="40" r="34"></circle>
    </svg>
    <button id="play" class="primary">Play</button>
  </div> -->

  <!-- Playback Controls -->
  <!--div style="text-align:center; margin-bottom:1rem;">
    <button id="pause" class="secondary">Pause</button>
    <button id="stop" class="secondary">Stop</button>
    <button id="next" class="secondary">Force Next</button>
  </div> -->

  <!-- Chapter Progress Bar -->
  <!--div id="progressContainer">
    <div id="progressBar"></div>
  </div> -->

  <!-- Chapter Text Display -->
  <!--div class="card">
    <div id="chapterText" style="white-space: pre-wrap;"></div>
    <div id="playStatus" class="status"></div>
  </div>

  <-- Your existing script tag stays below -->
  <!--script src="app.js"></script> -->

<!--</body>

<h1>Bible Daily TTS (KJV)</h1>
<button id="toggleTheme" class= "secondary" style="margin-top:0.5rem;">Dark Mode</button>
<div class="small">Reads one chapter per day · Uses API.Bible + browser TTS</div>

<div class="card">
  <h2>1. API.Bible Setup</h2>
  <label>API Key</label>
  <input id="apiKey" placeholder="Paste your API.Bible key" />
  <button id="saveKey" class="secondary" style="margin-top:0.5rem;">Save Key</button>
  <div id="keyStatus" class="status"></div>
</div>

<div class="card">
  <h2>2. Reading Plan</h2>
  <div class="small">Psalms → Proverbs → Acts → 1 Chronicles</div>
  <button id="resetProgress" class="secondary" style="margin-top:0.5rem;">Reset Progress</button>
  <div id="resetStatus" class="status"></div>
</div>

<div class="card">
  <div id="progressContainer">
  <div id="progressBar"></div>
  </div>

  <h2>3. Today's Reading</h2>
  <div id="todayInfo" class="small">Loading…</div>

  <button id="play" class="primary" style="margin-top:0.75rem;">Play</button>
  <button id="stop" class="secondary">Stop</button>
  <button id="pause" class="secondary">Pause</button>
  <button id="next" class="secondary">Force Next</button>

  <div id="playStatus" class="status"></div>
  
  <h2 style="margin-top:1.25rem;">Chapter Text</h2>
  <div id="chapterText">No text loaded.</div>
</div>

<script>
/* ---------------- CONFIG ---------------- */

const BIBLE_ID = "de4e12af7f28f599-01"; // KJV (Crosswire)
const PLAN = [
  { id: "PSA", apiId: "PSA", name: "Psalms", start: 1, end: 150 },
  { id: "PRO", apiId: "PRO", name: "Proverbs", start: 1, end: 31 },
  { id: "ACT", apiId: "ACT", name: "Acts", start: 1, end: 28 },
  { id: "CH1", apiId: "1CH", name: "1 Chronicles", start: 1, end: 29 }
];

const STORAGE_KEY = "bibleTTS_progress_kjv_playlist";
const STORAGE_KEY_API = "bibleTTS_apiKey_kjv";

/* ---------------- DOM ---------------- */

const apiKeyInput = document.getElementById("apiKey");
const saveKeyBtn = document.getElementById("saveKey");
const keyStatus = document.getElementById("keyStatus");

const resetBtn = document.getElementById("resetProgress");
const resetStatus = document.getElementById("resetStatus");

const todayInfo = document.getElementById("todayInfo");
const chapterTextDiv = document.getElementById("chapterText");

const playBtn = document.getElementById("play");
const pauseBtn = document.getElementById("pause");   // <-- NEW
const stopBtn = document.getElementById("stop");
const nextBtn = document.getElementById("next");
const playStatus = document.getElementById("playStatus");
const toggleThemeBtn = document.getElementById("toggleTheme");


/* ---------------- STATE ---------------- */

let progress = null;
let currentText = "";
let playlistIndex = 0;

let isPaused = false;
let isSpeaking = false;

let progressInvterval = null;
let utterance = null;

/* ---------------- UTIL ---------------- */

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function loadApiKey() {
  const key = localStorage.getItem(STORAGE_KEY_API);
  if (key) apiKeyInput.value = key;
}

function saveApiKey() {
  const key = apiKeyInput.value.trim();
  if (!key) {
    keyStatus.textContent = "API key cleared.";
    keyStatus.className = "status";
    localStorage.removeItem(STORAGE_KEY_API);
    return;
  }
  localStorage.setItem(STORAGE_KEY_API, key);
  keyStatus.textContent = "API key saved.";
  keyStatus.className = "status success";
}

function loadProgress() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    progress = JSON.parse(stored);
  } else {
    progress = {
      PSA: 1,
      PRO: 1,
      ACT: 1,
      CH1: 1,
      lastPlayed: null
    };
    saveProgress();
  }
}

function saveProgress() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
}

function resetProgress() {
  progress = {
    PSA: 1,
    PRO: 1,
    ACT: 1,
    CH1: 1,
    lastPlayed: null
  };
  playlistIndex = 0;
  saveProgress();
  resetStatus.textContent = "Progress reset.";
  resetStatus.className = "status success";
  loadToday();
}

/* ---------------- FETCH CHAPTER ---------------- */

function fetchChapter() {
  return new Promise(async (resolve, reject) => {
    const entry = PLAN[playlistIndex];
    const chapterNum = progress[entry.id];
    const chapterId = `${entry.apiId}.${chapterNum}`;

    chapterTextDiv.textContent = "Loading…";

    try {
      const res = await fetch(`/chapter?bibleId=${BIBLE_ID}&chapterId=${chapterId}`);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();
      const tmp = document.createElement("div");
      tmp.innerHTML = data.data.content;
      currentText = tmp.textContent.trim();
      chapterTextDiv.textContent = currentText;

      resolve();
    } catch (e) {
      chapterTextDiv.textContent = "Error loading chapter.";
      playStatus.textContent = "Fetch failed.";
      playStatus.className = "status error";
      reject(e);
    }
  });
}

/* ---------------- DAILY LOGIC ---------------- */

function advance() {
  const entry = PLAN[playlistIndex];
  if (progress[entry.id] < entry.end) {
    progress[entry.id]++;
  } else {
    progress[entry.id] = entry.start;
  }
  saveProgress();
}

function loadToday() {
  const entry = PLAN[playlistIndex];
  todayInfo.textContent = `Track ${playlistIndex + 1} of ${PLAN.length}: ${entry.name} ${progress[entry.id]}`;
  return fetchChapter();
}

/* ---------------- TTS ---------------- */

function speak() {
  if (!currentText) {
    playStatus.textContent = "No text loaded.";
    playStatus.className = "status error";
    return;
  }

  utterance = new SpeechSynthesisUtterance(currentText);
  const u = utterance;

  utterance.onstart = () => {
    isSpeaking = true;
    isPaused = false;
    pauseBtn.textContent = "Pause";
    playStatus.textContent = `Reading track ${playlistIndex + 1}…`;
    playStatus.className = "status";

    // Reset progress bar
    document.getElementById("progressBar").style.width = "0%";

    // Start tracking progress
    progressInterval = setInterval(() => {
      if (!u || !u.text) return;

      const spoken = speechSynthesis.speaking && !speechSynthesis.paused;
      if (!spoken) return;

      const total = u.text.length;
      const current = u.charIndex || 0;
      const percent = (current / total) * 100;

      document.getElementById("progressBar").style.width = percent + "%";
    }, 100);
  };

  utterance.onend = async () => {
    isSpeaking = false;

    if (isPaused) return; // don't advance playlist while paused

    advance();
    playlistIndex++;

    if (playlistIndex < PLAN.length) {
      await loadToday();
      speak();
    } else {
      playStatus.textContent = "Daily playlist complete.";
      playStatus.className = "status success";

      progress.lastPlayed = todayISO();
      saveProgress();

      playlistIndex = 0;
    }

    clearInterval(progressInterval);
    document.getElementById("progressBar").style.width = "100%";
  };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
 
function stop() {
  speechSynthesis.cancel();
  isPaused = false;
  isSpeaking = false;
  pauseBtn.textContent = "Pause";
  playStatus.textContent = "Stopped.";
  clearInterval(progressInterval);
  document.getElementById("progressBar").style.width = "0%";
}

/* ---------------- EVENTS ---------------- */

saveKeyBtn.onclick = saveApiKey;
resetBtn.onclick = resetProgress;
toggleThemeBtn.onclick = () => {
  document.body.classList.toggle("dark");

  // Update button text
  if (document.body.classList.contains("dark")) {
    toggleThemeBtn.textContent = "Light Mode";
  } else {
    toggleThemeBtn.textContent = "Dark Mode";
  }

  // Save preference
  localStorage.setItem("bibleTTS_theme", document.body.classList.contains("dark") ? "dark" : "light");
};
playBtn.onclick = async () => {
  // Always reset TTS engine before starting
  speechSynthesis.cancel();
  isPaused = false;
  isSpeaking = false;
  pauseBtn.textContent = "Pause";

  const today = todayISO();
  const finishedToday = (progress.lastPlayed === today);

  // Only reset to Psalms if it's a NEW day AND we're at the start
  if (!finishedToday && playlistIndex === 0) {
    await loadToday();
  }

  speak();
};

pauseBtn.onclick = () => {
  if (!isSpeaking && !speechSynthesis.paused) return;

  if (!isPaused) {
    speechSynthesis.pause();
    isPaused = true;
    pauseBtn.textContent = "Resume";
    playStatus.textContent = "Paused.";
  } else {
    speechSynthesis.resume();
    isPaused = false;
    pauseBtn.textContent = "Pause";
    playStatus.textContent = `Reading track ${playlistIndex + 1}…`;
  }
};

nextBtn.onclick = async () => {
  // Reset TTS engine cleanly
  speechSynthesis.cancel();
  isPaused = false;
  isSpeaking = false;
  pauseBtn.textContent = "Pause";
  clearInterval(progressInterval);
  document.getElementById("progressBar").style.width = "0%";

  // DO NOT call stop() here — it breaks playback
  playlistIndex++;
  if (playlistIndex >= PLAN.length) playlistIndex = 0;

  await loadToday();
};

stopBtn.onclick = stop;

/* ---------------- INIT ---------------- */
const savedTheme = localStorage.getItem("bibleTTS_theme");
if (savedTheme === "dark") {
  document.body.classList.add("dark");
  toggleThemeBtn.textContent = "Light Mode";
}

loadApiKey();
loadProgress();
loadToday();
</script> -->